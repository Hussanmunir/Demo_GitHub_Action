
# ============================================
# CI/CD Pipeline (Single Workflow)
# - CI: Run tests on pull requests to main
# - CD: After merge to main, print "Ready for deployment" message
# - Deploy to staging and production sequentially (note: staging/production deployment is simulated)
# ============================================

name: CI/CD Pipeline (PR Tests + Deployment Message)

# Trigger workflow on:
# - Pull requests targeting main (CI phase)
# - Pushes to main (post-merge, CD phase)
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  # ============================================
  # Job 1 ‚Äî CI (Continuous Integration)
  # ‚Ä¢ Phase: CI - Code Validation
  # ‚Ä¢ Trigger: On every pull request to main
  # ============================================
  Build_Test:
    if: ${{ github.event_name == 'pull_request' }}  # Run only for PR events
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'  # Use latest Python 3.x version

      # Step 3: Install dependencies from requirements.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Run tests using pytest
      - name: Run tests
        run: pytest -v  # Verbose output for clarity in logs

      # Step 5: Print success message if tests pass
      - name: CI Passed ‚Äî Ready for manual merge
        if: success()
        run: echo "‚úÖ Tests passed on PR. Ready for manual review and merge."

  # ============================================
  # Job 2 ‚Äî CD (Continuous Deployment) - Ready
  # ‚Ä¢ Phase: CD - Post-Merge Notification
  # ‚Ä¢ Trigger: On push to main (after PR merge)
  # ============================================
  Deploy-message:
    # Run only when code is pushed to main (after merge)
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest

    steps:
      # Step 1: Print deployment-ready message
      - name: Ready for Deployment
        run: echo "‚úÖ Code merged into main. Ready for deployment"

  # ============================================
  # Job 3 ‚Äî CD (Continuous Deployment) - Stage 1
  # ‚Ä¢ Phase: CD - Staging Deployment
  # ‚Ä¢ Trigger: On push to main (after PR merge)
  # ============================================
  Deploy-staging:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    #environment: staging
    runs-on: ubuntu-latest

    steps:
      - run: echo "1Ô∏è‚É£ Deploying to staging..."
      - run: echo "2Ô∏è‚É£ Running staging tests (e.g.,Performance, configuration, security)..."
      - run: echo "3Ô∏è‚É£ ‚úÖ Staging deployment successful"
      # Note: Replace echo commands with actual deployment scripts
      # Example: docker build, docker push, kubectl apply, etc.

  # ============================================
  # Job 4 ‚Äî CD (Continuous Deployment) - Stage 2
  # ‚Ä¢ Phase: CD - Production Deployment (Final)
  # ‚Ä¢ Prerequisite: Waits for Job 3 (staging) success
  # ============================================
  Deploy-production:
    needs: Deploy-staging  # ‚Üê CRITICAL: Waits for staging!
    #environment: production
    runs-on: ubuntu-latest

    steps:
      - run: echo "üéØ Deploying to production (AFTER staging)..."
      - run: echo "üì¶ Production deployment in progress..."
      - run: echo "üéâ ‚úÖ Production deployment complete!"
      # Note: Replace echo commands with actual deployment scripts
      # Example: docker pull, docker run, kubectl apply, etc.
      # IMPORTANT: This job ONLY runs AFTER staging deployment succeeds!
